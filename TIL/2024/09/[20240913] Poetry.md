---
title: 20240913 Today I Learned
objective: Poetry
---

## [Poetry](https://python-poetry.org/)

- a tool for dependency management and packaging in Python.
- It allows you to declare the libraries your project depends on and it will manage (install/update) them for you.
- Poetry offers a lockfile to ensure repeatable installs, and can build your project for distribution.

### Install

#### Linux, macOS, Windows (WSL)

```bash
curl -sSL <https://install.python-poetry.org> | python3 -
```

#### Windows

```bash
(Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | py -
```

### Usage

#### Project Setup

```bash
poetry new poetry-demo
```

```
poetry-demo
├── pyproject.toml
├── README.md
├── poetry_demo
│   └── __init__.py
└── tests
    └── __init__.py
```

```toml
[tool.poetry]
name = "poetry-demo"
version = "0.1.0"
description = ""
authors = ["Sébastien Eustace <sebastien@eustace.io>"]
readme = "README.md"
packages = [{include = "poetry_demo"}]

[tool.poetry.dependencies]
python = "^3.7"


[build-system]
requires = ["poetry-core"]
build-backend = "poetry.core.masonry.api"
```

#### Initialising a pre-existing project

```bash
cd pre-existing-project
poetry init
```

#### Operating modes

- Poetry can be operated in two different modes.  
  - The default mode is the package mode, which is the right mode if you want to package your project into an sdist or a wheel and perhaps publish it to a package index.  
    - In this mode, some metadata such as name and version, which are required for packaging, are mandatory.  
    - the project itself will be installed in editable mode when running poetry install.
  - If you want to use Poetry only for dependency management but not for packaging, you can use the non-package mode:

  ```toml
  [tool.poetry]
  package-mode = false
  ```

  - In this mode, metadata such as name and version are optional.  
  - Therefore, it is not possible to build a distribution or publish the project to a package index.
  - Further, when running poetry install, Poetry does not try to install the project itself, but only its dependencies (same as poetry install --no-root).

#### Specifying dependencies

```toml
[tool.poetry.dependencies]
pendulum = "^2.1"
```

- you can use the add command.

    ```bash
    poetry add pendulum
    ```

- It will automatically find a suitable version constraint and install the package and sub-dependencies.

#### Using your virtual environment

- By default, Poetry creates a virtual environment in {cache-dir}/virtualenvs.
- You can change the cache-dir value by editing the Poetry configuration.
- Additionally, you can use the virtualenvs.
- in-project configuration variable to create virtual environments within your project directory.
There are several ways to run commands within this virtual environment.

##### VSCode로 Poetry 사용시 interpreter 인식 시키는 방법

```bash
poetry config virtualenvs.in-project true
poetry config virtualenvs.path "./.venv"
poetry install
```

#### Using poetry run

- To run your script simply use ```poetry run python your_script.py```.
- Likewise if you have command line tools such as ```pytest``` or ```black``` you can run them using ```poetry run pytest```.

#### Activating the virtual environment

- The easiest way to activate the virtual environment is to create a nested shell with ```poetry shell```.
- To deactivate the virtual environment and exit this new shell type ```exit```. To deactivate the virtual environment without leaving the shell use ```deactivate```.
- If you’d like to prevent ```poetry shell``` from modifying your shell prompt on virtual environment activation, you should set ```VIRTUAL_ENV_DISABLE_PROMPT=1``` as an environment variable before running the command.
  - Alternatively, to avoid creating a new shell, you can manually activate the virtual environment by running ```source {path_to_venv}/bin/activate``` (```{path_to_venv}\Scripts\activate.ps1``` in PowerShell).  
  - To get the path to your virtual environment ```run poetry env info --path```.  
  - You can also combine these into a one-liner, such as ```source $(poetry env info --path)/bin/activate``` (```& ((poetry env info --path) + "\Scripts\activate.ps1")``` in Powershell).
  - To deactivate this virtual environment simply use ```deactivate```.

#### Installing dependencies

- To install the defined dependencies for your project, just run the ```install``` command.

```bash
poetry install
```

- When you run this command, one of two things may happen:
  - Installing without `poetry.lock`[](https://python-poetry.org/docs/basic-usage/#installing-without-poetrylock)
   If you have never run the command before and there is also no `poetry.lock` file present, Poetry simply resolves all dependencies listed in your `pyproject.toml` file and downloads the latest version of their files.
   When Poetry has finished installing, it writes all the packages and their exact versions that it downloaded to the `poetry.lock` file, locking the project to those specific versions. You should commit the `poetry.lock` file to your project repo so that all people working on the project are locked to the same versions of dependencies (more below).
  - Installing with `poetry.lock`[](https://python-poetry.org/docs/basic-usage/#installing-with-poetrylock)
   This brings us to the second scenario. If there is already a `poetry.lock` file as well as a `pyproject.toml` file when you run `poetry install`, it means either you ran the `install` command before, or someone else on the project ran the `install` command and committed the `poetry.lock` file to the project (which is good).
   Either way, running `install` when a `poetry.lock` file is present resolves and installs all dependencies that you listed in `pyproject.toml`, but Poetry uses the exact versions listed in `poetry.lock` to ensure that the package versions are consistent for everyone working on your project. As a result you will have all dependencies requested by your `pyproject.toml` file, but they may not all be at the very latest available versions (some dependencies listed in the `poetry.lock` file may have released newer versions since the file was created). This is by design, it ensures that your project does not break because of unexpected changes in dependencies.
